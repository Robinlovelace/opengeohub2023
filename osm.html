<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>opengeohub23 - Processing large OpenStreetMap datasets for research</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">opengeohub23</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./tidy.html" rel="" target="">
 <span class="menu-text">Tidy geographic data</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./tidy-slides.html" rel="" target="">
 <span class="menu-text">Tidy geographic data: slides</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="./osm.html" rel="" target="" aria-current="page">
 <span class="menu-text">Large OSM datasets</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./osm-slides.html" rel="" target="">
 <span class="menu-text">Large OSM datasets: slides</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools ms-auto">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#prerequisites" id="toc-prerequisites" class="nav-link" data-scroll-target="#prerequisites">Prerequisites</a></li>
  <li><a href="#sec-download" id="toc-sec-download" class="nav-link" data-scroll-target="#sec-download">How and where to download OSM data</a>
  <ul class="collapse">
  <li><a href="#uncompressed-osm-providers" id="toc-uncompressed-osm-providers" class="nav-link" data-scroll-target="#uncompressed-osm-providers">Uncompressed OSM providers</a></li>
  <li><a href="#geofabrik" id="toc-geofabrik" class="nav-link" data-scroll-target="#geofabrik">Geofabrik</a></li>
  <li><a href="#openstreetmap.fr" id="toc-openstreetmap.fr" class="nav-link" data-scroll-target="#openstreetmap.fr">Openstreetmap.fr</a></li>
  <li><a href="#bbbike" id="toc-bbbike" class="nav-link" data-scroll-target="#bbbike">BBBike</a></li>
  </ul></li>
  <li><a href="#sec-osmdata" id="toc-sec-osmdata" class="nav-link" data-scroll-target="#sec-osmdata">How to process small amounts of OSM data using the osmdata R package</a></li>
  <li><a href="#sec-osmextract" id="toc-sec-osmextract" class="nav-link" data-scroll-target="#sec-osmextract">How to process large OSM ‘extracts’ data with the osmextract R package</a>
  <ul class="collapse">
  <li><a href="#finding-an-extract-to-download" id="toc-finding-an-extract-to-download" class="nav-link" data-scroll-target="#finding-an-extract-to-download">Finding an extract to download</a></li>
  <li><a href="#downloading-the-extract" id="toc-downloading-the-extract" class="nav-link" data-scroll-target="#downloading-the-extract">Downloading the extract</a></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises">Exercises</a></li>
  <li><a href="#clipping-an-area-of-interest" id="toc-clipping-an-area-of-interest" class="nav-link" data-scroll-target="#clipping-an-area-of-interest">Clipping an area of interest</a></li>
  </ul></li>
  <li><a href="#sec-command-line" id="toc-sec-command-line" class="nav-link" data-scroll-target="#sec-command-line">Other command line tools for working with OSM data</a>
  <ul class="collapse">
  <li><a href="#pyrosm" id="toc-pyrosm" class="nav-link" data-scroll-target="#pyrosm">pyrosm</a></li>
  <li><a href="#osmnx" id="toc-osmnx" class="nav-link" data-scroll-target="#osmnx">osmnx</a></li>
  <li><a href="#osmium" id="toc-osmium" class="nav-link" data-scroll-target="#osmium">osmium</a></li>
  <li><a href="#exercises-1" id="toc-exercises-1" class="nav-link" data-scroll-target="#exercises-1">Exercises</a></li>
  </ul></li>
  <li><a href="#sec-ideas" id="toc-sec-ideas" class="nav-link" data-scroll-target="#sec-ideas">Ideas for using OSM data</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Processing large OpenStreetMap datasets for research</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>This practical was developed for the <a href="https://pretalx.earthmonitor.org/opengeohub-summer-school-2023/schedule/">OpenGeoHub summer school 2023</a>.</p>
<p>As outlined in the session abstract, will cover</p>
<ul>
<li>How and where to download OSM data</li>
<li>How to process small amounts of OSM data using the osmdata R package</li>
<li>How to process large OSM ‘extracts’ data with the osmextract R package</li>
<li>Other command line tools for working with OSM data, including the mature and widely used osmium tool, the pyrosm Python package and the osm2streets web application and Rust codebase</li>
</ul>
<p>Finally, the session will outline ideas for using OSM data to support the fast and fair decarbonisation of the global economy.</p>
</section>
<section id="prerequisites" class="level1">
<h1>Prerequisites</h1>
<p>To participate in the session, all you need is R and following packages:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>pkgs <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"tidyverse"</span>,</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"osmdata"</span>,</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"osmextract"</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>remotes<span class="sc">::</span><span class="fu">install_cran</span>(pkgs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You may want to install the following packages for <a href="#sec-command-line">Section&nbsp;6</a>:</p>
<ul>
<li><a href="https://pyrosm.readthedocs.io/en/latest/">pyrosm</a></li>
<li><a href="https://osmnx.readthedocs.io/en/stable/">osmnx</a></li>
<li><a href="https://osmcode.org/osmium-tool/">osmium</a></li>
<li><a href="https://a-b-street.github.io/osm2streets/#1/0/0">osm2streets</a> (although this is currently mostly a web UI and does not have a command line interface)</li>
</ul>
<p>We will get data representing case study areas:</p>
<ul>
<li></li>
</ul>
</section>
<section id="sec-download" class="level1">
<h1>How and where to download OSM data</h1>
<p>There are two main ways to download OSM data:</p>
<ul>
<li>In small amounts, which you can get from osm.org directly, and from <a href="">services</a> that host the Overpass API and provide free access.</li>
<li>In large amounts, which you can get from a smaller number of extract providers. Because the focus of this session is on large amounts of data, and because providers of small uncompressed datasets cannot scale to national or global datasets, we will focus on this second way of getting data, with key providers described below.</li>
</ul>
<section id="uncompressed-osm-providers" class="level2">
<h2 class="anchored" data-anchor-id="uncompressed-osm-providers">Uncompressed OSM providers</h2>
<p>Queries to Overpass API providers can be made directly from the <a href="https://overpass-turbo.eu/">Overpass Turbo</a> web application, which has a convenient web interface that is ideal for exploring the data and writing queries iteratively.</p>
<p>Overpass users the <a href="https://wiki.openstreetmap.org/wiki/Overpass_API/Overpass_QL">Overpass QL</a>, an example of which is provided below. You can see the results of a query at this endpoint, for example: https://overpass-turbo.eu/?Q=%28%0A+++node%2851.249%2C7.148%2C51.251%2C7.152%29%3B%0A+++%3C%3B%0A%29%3B%0Aout+meta%3B</p>
<p>This can be written in Overpass QL as:</p>
<pre class="overpass"><code>(
  node(51.249,7.148,51.251,7.152);
  &lt;;
);
out meta;</code></pre>
<p>After saving this query as a file (e.g.&nbsp;called <code>query.txt</code>), you can download the data using the <code>curl</code> command line tool as follows:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-X</span> POST <span class="at">-H</span> <span class="st">"Content-Type: application/x-www-form-urlencoded"</span> <span class="at">-d</span> @query.txt https://overpass-api.de/api/interpreter <span class="op">&gt;</span> data.osm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>As outlined in the <a href="https://docs.ropensci.org/osmextract/articles/providers_comparisons.html"><code>providers_comparison</code></a> vignette in the <a href="https://docs.ropensci.org/osmextract/"><code>osmextract</code></a> package, there are several providers of OSM data. The main ones that provide regular extracts without need for logins are:</p>
<ul>
<li><a href="https://download.geofabrik.de/">geofabrik</a></li>
<li><a href="http://download.openstreetmap.fr/">openstreetmap_fr</a></li>
<li><a href="https://download.bbbike.org/osm/bbbike/">bbbike</a></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(osmextract)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Data (c) OpenStreetMap contributors, ODbL 1.0. https://www.openstreetmap.org/copyright.
Check the package website, https://docs.ropensci.org/osmextract/, for more details.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Linking to GEOS 3.10.2, GDAL 3.4.1, PROJ 8.2.1; sf_use_s2() is TRUE</code></pre>
</div>
</div>
<p>Extracts from each provider are shown in the figures below, generated by code that can be ‘unfolded’ by clicking on the arrows:</p>
</section>
<section id="geofabrik" class="level2">
<h2 class="anchored" data-anchor-id="geofabrik">Geofabrik</h2>
<p><code>geofabrik</code> is a company that provides map-based services and free downloads of OSM extracts that are updated daily. These extracts are based on a division of the world into different regions, at 4 different levels. Zones in level 1 cover a whole continent (plus Russian Federation):</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="dv">4</span>))</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(geofabrik_zones[geofabrik_zones<span class="sc">$</span>level <span class="sc">==</span> <span class="dv">1</span>, <span class="st">"name"</span>], <span class="at">key.pos =</span> <span class="cn">NULL</span>, <span class="at">main =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="osm_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Level 2 contains polygons representing several countries all around the world:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(geofabrik_zones[geofabrik_zones<span class="sc">$</span>level <span class="sc">==</span> <span class="dv">2</span>, <span class="st">"name"</span>], <span class="at">key.pos =</span> <span class="cn">NULL</span>, <span class="at">main =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="osm_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Geofabrik also defines several special zones, such as Alps, Britain and Ireland, Germany, Austria and Switzerland, US Midwest, US Northeast, US Pacific, US South and US West (level 3). Moreover, it contains extracts relative to some administrative subregions, mainly in Europe, Russia, Canada and South America:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(geofabrik_zones[geofabrik_zones<span class="sc">$</span>level <span class="sc">==</span> <span class="dv">3</span>, <span class="st">"name"</span>], <span class="at">key.pos =</span> <span class="cn">NULL</span>, <span class="at">main =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="osm_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Check <code>?geofabrik_zones</code> and the <a href="http://download.geofabrik.de/">provider’s webpage</a> for more details.</p>
</section>
<section id="openstreetmap.fr" class="level2">
<h2 class="anchored" data-anchor-id="openstreetmap.fr">Openstreetmap.fr</h2>
<p><code>openstreetmap_fr</code> extracts are taken from http://download.openstreetmap.fr/, a web-service that provides OSM data updated every few minutes. The extracts are based on several regions, such as the continents (level 1):</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Russian federation is considered as a level 1 zone</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(openstreetmap_fr_zones[openstreetmap_fr_zones<span class="sc">$</span>level <span class="sc">==</span> <span class="dv">1</span>, <span class="st">"name"</span>], <span class="at">key.pos =</span> <span class="cn">NULL</span>, <span class="at">main =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="osm_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>or some countries around the world (less than <code>geofabrik</code>’s level 2 zones):</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(openstreetmap_fr_zones[openstreetmap_fr_zones<span class="sc">$</span>level <span class="sc">==</span> <span class="dv">2</span>, <span class="st">"name"</span>], <span class="at">key.pos =</span> <span class="cn">NULL</span>, <span class="at">main =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="osm_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>India,</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(openstreetmap_fr_zones[openstreetmap_fr_zones<span class="sc">$</span>parent <span class="sc">==</span> <span class="st">"india"</span>, <span class="st">"name"</span>], <span class="at">key.pos =</span> <span class="cn">NULL</span>, <span class="at">main =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="osm_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>France,</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>ids_2 <span class="ot">=</span> openstreetmap_fr_zones<span class="sc">$</span>parent <span class="sc">%in%</span> <span class="st">"france"</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>ids_3 <span class="ot">=</span> openstreetmap_fr_zones<span class="sc">$</span>parent <span class="sc">%in%</span> openstreetmap_fr_zones<span class="sc">$</span>id[ids_2]</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(openstreetmap_fr_zones[ids_2 <span class="sc">|</span> ids_3, <span class="st">"name"</span>], <span class="at">key.pos =</span> <span class="cn">NULL</span>, <span class="at">main =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="osm_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>and Brazil</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>ids_2 <span class="ot">=</span> openstreetmap_fr_zones<span class="sc">$</span>parent <span class="sc">%in%</span> <span class="st">"brazil"</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>ids_3 <span class="ot">=</span> openstreetmap_fr_zones<span class="sc">$</span>parent <span class="sc">%in%</span> openstreetmap_fr_zones<span class="sc">$</span>id[ids_2]</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(openstreetmap_fr_zones[ids_2 <span class="sc">|</span> ids_3, <span class="st">"name"</span>], <span class="at">key.pos =</span> <span class="cn">NULL</span>, <span class="at">main =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="osm_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="bbbike" class="level2">
<h2 class="anchored" data-anchor-id="bbbike">BBBike</h2>
<p><code>bbbike</code> provider is based on https://download.bbbike.org/osm/bbbike/. It is quite different from any other provider supported in <code>osmextract</code> since it contains OSM data for more than 200 cities worldwide.</p>
<p><img src="https://docs.ropensci.org/osmextract/reference/figures/96640949-3f7f7480-1324-11eb-9dca-a971c8103a4e.png" class="img-fluid"></p>
<p><code>bbbike</code> provider is the safest choice if you are looking for OSM data relative to a particular city in the world.</p>
</section>
</section>
<section id="sec-osmdata" class="level1">
<h1>How to process small amounts of OSM data using the osmdata R package</h1>
<p>The <a href="https://cran.r-project.org/package=osmdata">osmdata</a> package is a mature and widely used tool for working with OSM data in R. It is designed to work with small amounts of data, such as the area around a city or a country. It is not designed to work with large amounts of data, such as the whole of Europe or the world. For that, we need a different approach, which is covered in the next section.</p>
</section>
<section id="sec-osmextract" class="level1">
<h1>How to process large OSM ‘extracts’ data with the osmextract R package</h1>
<p>The quickest way to get large OSM datasets in R (and possibly in any data analysis framework) is to use the <a href="https://docs.ropensci.org/osmextract/"><code>osmextract</code></a> package.</p>
<p>The package makes your life easy by automating many parts of the OSM extract identification, download, and processing pipeline, so you can focus on the analysis and high-impact reasearch!</p>
<section id="finding-an-extract-to-download" class="level2">
<h2 class="anchored" data-anchor-id="finding-an-extract-to-download">Finding an extract to download</h2>
<p>Let’s see how it works for the city of Poznan:</p>
<p>We geocode the coordinates of Poznan, Poland</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>poznan <span class="ot">=</span> tmaptools<span class="sc">::</span><span class="fu">geocode_OSM</span>(<span class="st">"Poznan, Poland"</span>)<span class="sc">$</span>coords</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="co"># poznan = c(x = 16.933, y = 52.408)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and look for a match in the OSM extracts using <code>oe_match()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">oe_match</span>(poznan, <span class="at">provider =</span> <span class="st">"geofabrik"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$url
[1] "https://download.geofabrik.de/europe/poland/wielkopolskie-latest.osm.pbf"

$file_size
[1] 1.26e+08</code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">oe_match</span>(poznan, <span class="at">provider =</span> <span class="st">"bbbike"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$url
[1] "https://download.bbbike.org/osm/bbbike/Poznan/Poznan.osm.pbf"

$file_size
[1] 25856507</code></pre>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">oe_match</span>(poznan, <span class="at">provider =</span> <span class="st">"openstreetmap_fr"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$url
[1] "http://download.openstreetmap.fr/extracts/europe/poland/wielkopolskie-latest.osm.pbf"

$file_size
[1] 143404382</code></pre>
</div>
</div>
<p>As shown above, <code>bbbike</code> is the only provide that provides a match for Poznan (the others match with all of Poland).</p>
</section>
<section id="downloading-the-extract" class="level2">
<h2 class="anchored" data-anchor-id="downloading-the-extract">Downloading the extract</h2>
<p>We can download the extract using <code>oe_get()</code>, noting the user of <code>layer = "points"</code> to get the points layer of the OSM data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>poznan <span class="ot">=</span> <span class="fu">oe_get</span>(<span class="st">"Poznan"</span>, <span class="at">provider =</span> <span class="st">"bbbike"</span>, <span class="at">force_vectortranslate =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Find where the file is as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>poznan_file <span class="ot">=</span> <span class="fu">oe_find</span>(<span class="st">"Poznan"</span>, <span class="at">provider =</span> <span class="st">"bbbike"</span>, <span class="at">return_gpkg =</span> <span class="cn">FALSE</span>)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="co"># [1] "/home/robin/data/osm/bbbike_Poznan.osm.pbf"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note: you can check the location where datasets will be downloaded and translated using the <a href="https://docs.ropensci.org/osmextract/reference/oe_download_directory.html"><code>oe_download_directory()</code></a> function (see <code>?oe_download_directory</code> for details).</p>
<p>We uploaded data for Poznan to <a href="https://github.com/Robinlovelace/opengeohub2023/releases/tag/v2">github.com/Robinlovelace/opengeohub2023/releases</a>. For future reference, you can access the 25 MB PBF file from https://github.com/Robinlovelace/opengeohub2023/releases/download/v2/bbbike_Poznan.osm.pbf</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">file.copy</span>(poznan_file, <span class="st">"."</span>)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>msg_upload_github <span class="ot">=</span> glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"gh release create v2 {poznan_file}"</span>)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="fu">system</span>(msg_upload_github)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note: that takes quite a while download, so we will use a smaller extract for the rest of the session:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>monaco_osm_points <span class="ot">=</span> <span class="fu">oe_get</span>(<span class="st">"monaco"</span>, <span class="at">provider =</span> <span class="st">"bbbike"</span>, <span class="at">layer =</span> <span class="st">"points"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>No exact match found for place = monaco and provider = bbbike. Best match is Moscow. 
Checking the other providers.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>An exact string match was found using provider = geofabrik.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Downloading the OSM extract:</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
  |                                                                            
  |                                                                      |   0%
  |                                                                            
  |=                                                                     |   1%
  |                                                                            
  |=                                                                     |   2%
  |                                                                            
  |==                                                                    |   2%
  |                                                                            
  |==                                                                    |   3%
  |                                                                            
  |===                                                                   |   4%
  |                                                                            
  |===                                                                   |   5%
  |                                                                            
  |====                                                                  |   6%
  |                                                                            
  |=====                                                                 |   7%
  |                                                                            
  |======                                                                |   8%
  |                                                                            
  |======                                                                |   9%
  |                                                                            
  |=======                                                               |  10%
  |                                                                            
  |========                                                              |  11%
  |                                                                            
  |========                                                              |  12%
  |                                                                            
  |=========                                                             |  13%
  |                                                                            
  |=========                                                             |  14%
  |                                                                            
  |==========                                                            |  14%
  |                                                                            
  |===========                                                           |  15%
  |                                                                            
  |===========                                                           |  16%
  |                                                                            
  |============                                                          |  17%
  |                                                                            
  |============                                                          |  18%
  |                                                                            
  |=============                                                         |  18%
  |                                                                            
  |=============                                                         |  19%
  |                                                                            
  |==============                                                        |  20%
  |                                                                            
  |===============                                                       |  21%
  |                                                                            
  |===============                                                       |  22%
  |                                                                            
  |================                                                      |  22%
  |                                                                            
  |================                                                      |  23%
  |                                                                            
  |=================                                                     |  24%
  |                                                                            
  |=================                                                     |  25%
  |                                                                            
  |==================                                                    |  26%
  |                                                                            
  |===================                                                   |  27%
  |                                                                            
  |====================                                                  |  28%
  |                                                                            
  |====================                                                  |  29%
  |                                                                            
  |=====================                                                 |  30%
  |                                                                            
  |======================                                                |  31%
  |                                                                            
  |======================                                                |  32%
  |                                                                            
  |=======================                                               |  33%
  |                                                                            
  |=======================                                               |  34%
  |                                                                            
  |========================                                              |  34%
  |                                                                            
  |=========================                                             |  35%
  |                                                                            
  |=========================                                             |  36%
  |                                                                            
  |==========================                                            |  37%
  |                                                                            
  |==========================                                            |  38%
  |                                                                            
  |===========================                                           |  38%
  |                                                                            
  |===========================                                           |  39%
  |                                                                            
  |============================                                          |  40%
  |                                                                            
  |=============================                                         |  41%
  |                                                                            
  |=============================                                         |  42%
  |                                                                            
  |==============================                                        |  42%
  |                                                                            
  |==============================                                        |  43%
  |                                                                            
  |===============================                                       |  44%
  |                                                                            
  |===============================                                       |  45%
  |                                                                            
  |================================                                      |  46%
  |                                                                            
  |=================================                                     |  47%
  |                                                                            
  |==================================                                    |  48%
  |                                                                            
  |==================================                                    |  49%
  |                                                                            
  |===================================                                   |  50%
  |                                                                            
  |====================================                                  |  51%
  |                                                                            
  |====================================                                  |  52%
  |                                                                            
  |=====================================                                 |  53%
  |                                                                            
  |=====================================                                 |  54%
  |                                                                            
  |======================================                                |  54%
  |                                                                            
  |=======================================                               |  55%
  |                                                                            
  |=======================================                               |  56%
  |                                                                            
  |========================================                              |  57%
  |                                                                            
  |========================================                              |  58%
  |                                                                            
  |=========================================                             |  58%
  |                                                                            
  |=========================================                             |  59%
  |                                                                            
  |==========================================                            |  60%
  |                                                                            
  |===========================================                           |  61%
  |                                                                            
  |===========================================                           |  62%
  |                                                                            
  |============================================                          |  62%
  |                                                                            
  |============================================                          |  63%
  |                                                                            
  |=============================================                         |  64%
  |                                                                            
  |=============================================                         |  65%
  |                                                                            
  |==============================================                        |  66%
  |                                                                            
  |===============================================                       |  67%
  |                                                                            
  |================================================                      |  68%
  |                                                                            
  |================================================                      |  69%
  |                                                                            
  |=================================================                     |  70%
  |                                                                            
  |==================================================                    |  71%
  |                                                                            
  |==================================================                    |  72%
  |                                                                            
  |===================================================                   |  73%
  |                                                                            
  |====================================================                  |  74%
  |                                                                            
  |=====================================================                 |  75%
  |                                                                            
  |=====================================================                 |  76%
  |                                                                            
  |======================================================                |  77%
  |                                                                            
  |======================================================                |  78%
  |                                                                            
  |=======================================================               |  78%
  |                                                                            
  |=======================================================               |  79%
  |                                                                            
  |========================================================              |  80%
  |                                                                            
  |=========================================================             |  81%
  |                                                                            
  |=========================================================             |  82%
  |                                                                            
  |==========================================================            |  82%
  |                                                                            
  |==========================================================            |  83%
  |                                                                            
  |===========================================================           |  84%
  |                                                                            
  |===========================================================           |  85%
  |                                                                            
  |============================================================          |  86%
  |                                                                            
  |=============================================================         |  87%
  |                                                                            
  |==============================================================        |  88%
  |                                                                            
  |==============================================================        |  89%
  |                                                                            
  |===============================================================       |  90%
  |                                                                            
  |================================================================      |  91%
  |                                                                            
  |================================================================      |  92%
  |                                                                            
  |=================================================================     |  93%
  |                                                                            
  |==================================================================    |  94%
  |                                                                            
  |===================================================================   |  95%
  |                                                                            
  |===================================================================   |  96%
  |                                                                            
  |====================================================================  |  97%
  |                                                                            
  |====================================================================  |  98%
  |                                                                            
  |===================================================================== |  98%
  |                                                                            
  |===================================================================== |  99%
  |                                                                            
  |======================================================================| 100%</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>File downloaded!</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Starting with the vectortranslate operations on the input file!</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>0...10...20...30...40...50...60...70...80...90...100 - done.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Finished the vectortranslate operations on the input file!</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Reading layer `points' from data source 
  `/tmp/RtmpCveZdk/geofabrik_monaco-latest.gpkg' using driver `GPKG'
Simple feature collection with 3056 features and 10 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 7.408202 ymin: 43.51654 xmax: 7.500245 ymax: 43.75175
Geodetic CRS:  WGS 84</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ?oe_get</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>monaco_osm_lines <span class="ot">=</span> <span class="fu">oe_get</span>(<span class="st">"monaco"</span>, <span class="at">provider =</span> <span class="st">"bbbike"</span>, <span class="at">layer =</span> <span class="st">"lines"</span>)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>monaco_osm_mlines <span class="ot">=</span> <span class="fu">oe_get</span>(<span class="st">"monaco"</span>, <span class="at">provider =</span> <span class="st">"bbbike"</span>, <span class="at">layer =</span> <span class="st">"multilinestrings"</span>)</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>monaco_osm_polygons <span class="ot">=</span> <span class="fu">oe_get</span>(<span class="st">"monaco"</span>, <span class="at">provider =</span> <span class="st">"bbbike"</span>, <span class="at">layer =</span> <span class="st">"multipolygons"</span>)</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>monaco_osm_other <span class="ot">=</span> <span class="fu">oe_get</span>(<span class="st">"monaco"</span>, <span class="at">provider =</span> <span class="st">"bbbike"</span>, <span class="at">layer =</span> <span class="st">"other_relations"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You can look at the files downloaded as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>f <span class="ot">=</span> <span class="fu">list.files</span>(<span class="fu">oe_download_directory</span>(), <span class="at">pattern =</span> <span class="st">"monaco"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>f</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "/tmp/RtmpCveZdk/geofabrik_monaco-latest.gpkg"   
[2] "/tmp/RtmpCveZdk/geofabrik_monaco-latest.osm.pbf"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>monaco <span class="ot">=</span> sf<span class="sc">::</span><span class="fu">read_sf</span>(f[<span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in CPL_read_ogr(dsn, layer, query, as.character(options), quiet, :
automatically selected the first layer in a data source containing more than
one.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>monaco <span class="ot">=</span> sf<span class="sc">::</span><span class="fu">read_sf</span>(f[<span class="dv">2</span>], <span class="at">layer =</span> <span class="st">"lines"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s take a look at the size of each layer, in units of MB:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>sizes_mb <span class="ot">=</span> <span class="fu">sapply</span>(<span class="fu">list</span>(monaco_osm_points, monaco_osm_lines, monaco_osm_mlines, monaco_osm_polygons, monaco_osm_other), <span class="cf">function</span>(x) {</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">round</span>(<span class="fu">object.size</span>(x) <span class="sc">/</span> <span class="fl">1e6</span>, <span class="dv">1</span>)</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>layer_names <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"points"</span>, <span class="st">"lines"</span>, <span class="st">"multilinestrings"</span>, <span class="st">"multipolygons"</span>, <span class="st">"other_relations"</span>)</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>n_features <span class="ot">=</span> <span class="fu">sapply</span>(<span class="fu">list</span>(monaco_osm_points, monaco_osm_lines, monaco_osm_mlines, monaco_osm_polygons, monaco_osm_other), nrow)</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>size_df <span class="ot">=</span> <span class="fu">data.frame</span>(</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">layer =</span> layer_names,</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">size_mb =</span> sizes_mb,</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_features =</span> n_features,</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">kb_per_feature =</span> sizes_mb <span class="sc">/</span> n_features <span class="sc">*</span> <span class="fl">1e3</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(size_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">layer</th>
<th style="text-align: right;">size_mb</th>
<th style="text-align: right;">n_features</th>
<th style="text-align: right;">kb_per_feature</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">points</td>
<td style="text-align: right;">2.0</td>
<td style="text-align: right;">3056</td>
<td style="text-align: right;">0.6544503</td>
</tr>
<tr class="even">
<td style="text-align: left;">lines</td>
<td style="text-align: right;">2.7</td>
<td style="text-align: right;">3066</td>
<td style="text-align: right;">0.8806262</td>
</tr>
<tr class="odd">
<td style="text-align: left;">multilinestrings</td>
<td style="text-align: right;">1.1</td>
<td style="text-align: right;">61</td>
<td style="text-align: right;">18.0327869</td>
</tr>
<tr class="even">
<td style="text-align: left;">multipolygons</td>
<td style="text-align: right;">2.2</td>
<td style="text-align: right;">1729</td>
<td style="text-align: right;">1.2724118</td>
</tr>
<tr class="odd">
<td style="text-align: left;">other_relations</td>
<td style="text-align: right;">0.3</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">3.0000000</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="exercises" class="level2">
<h2 class="anchored" data-anchor-id="exercises">Exercises</h2>
<ul>
<li>Create maps of the different layers using <code>{tmap}</code>, <code>{ggplot2}</code> or a mapping package of your choice.</li>
<li>Which layer is most interesting for your research?</li>
<li>Are there any phenomena that are represented in more than one layer and, if so, thoughts on how to combine them?</li>
<li>Take a look at the <a href=""><code>demo.Rmd</code></a> file in the <a href="https://github.com/sfnetworks/OGH2021">sfnetworks/OGH2023 repo</a> and try to reproduce the results for Poznan.</li>
</ul>
</section>
<section id="clipping-an-area-of-interest" class="level2">
<h2 class="anchored" data-anchor-id="clipping-an-area-of-interest">Clipping an area of interest</h2>
<p>Rather than read-in the entire extract, you can read-in a subset…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>pois_buffer_simple <span class="ot">=</span> sf<span class="sc">::</span><span class="fu">st_read</span>(<span class="st">"https://github.com/Robinlovelace/opengeohub2023/raw/main/pois_buffer_simple.geojson"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Reading layer `pois_buffer_simple' from data source 
  `https://github.com/Robinlovelace/opengeohub2023/raw/main/pois_buffer_simple.geojson' 
  using driver `GeoJSON'
Simple feature collection with 1 feature and 0 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: 16.92972 ymin: 52.45306 xmax: 16.96174 ymax: 52.47165
Geodetic CRS:  WGS 84</code></pre>
</div>
</div>
</section>
</section>
<section id="sec-command-line" class="level1">
<h1>Other command line tools for working with OSM data</h1>
<section id="pyrosm" class="level2">
<h2 class="anchored" data-anchor-id="pyrosm">pyrosm</h2>
<p>Install the Python package <code>pyrosm</code> as follows:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install pyrosm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<!---
 See issue here https://github.com/HTenkanen/pyrosm/issues/217 
--->
<p>Search for Poznan in extracts available from <code>pyrosm</code> as follows (note: this fails for me currently as documented in <a href="https://github.com/HTenkanen/pyrosm/issues/217">github.com/HTenkanen/pyrosm/issues/217</a>):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyrosm</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyrosm <span class="im">import</span> OSM</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>poznan_file <span class="op">=</span> pyrosm.get_data(<span class="st">"Poznan"</span>)</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>osm <span class="op">=</span> OSM(poznan_file)</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>poznan_cycling <span class="op">=</span> osm.get_network(network_type<span class="op">=</span><span class="st">"cycling"</span>)</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>poznan_cycling.plot()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="osmnx" class="level2">
<h2 class="anchored" data-anchor-id="osmnx">osmnx</h2>
<p>Install the Python package <code>osmnx</code> as follows:</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install osmnx</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> osmnx <span class="im">as</span> ox</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>/home/runner/.virtualenvs/r-reticulate/lib/python3.10/site-packages/geopandas/_compat.py:124: UserWarning: The Shapely GEOS version (3.11.1-CAPI-1.17.1) is incompatible with the GEOS version PyGEOS was compiled with (3.10.4-CAPI-1.16.2). Conversions between both will be slow.
  warnings.warn(</code></pre>
</div>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Get cycle netework for Poznan</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>poznan_polygon <span class="op">=</span> ox.geocode_to_gdf(<span class="st">"Poznan, Poland"</span>)</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>poznan_polygon.plot()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="osm_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid" width="614"></p>
</div>
</div>
<p>That is quite a big network, so let’s get the area of the polygon and use that to get a smaller network from <a href="https://github.com/Robinlovelace/opengeohub2023/raw/main/pois_buffer_simple.geojson">GitHub</a>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get data from https://github.com/Robinlovelace/opengeohub2023/raw/main/pois_buffer_simple.geojson:</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>poznan_small <span class="op">=</span> gpd.read_file(<span class="st">"https://github.com/Robinlovelace/opengeohub2023/raw/main/pois_buffer_simple.geojson"</span>)</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>poznan_small.plot()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="osm_files/figure-html/unnamed-chunk-27-3.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Download the cycling network as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>G_cycle <span class="op">=</span> ox.graph_from_polygon(poznan_small.geometry[<span class="dv">0</span>], network_type<span class="op">=</span><span class="st">"bike"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Plot the results:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>ox.plot_graph(G_cycle)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="osm_files/figure-html/unnamed-chunk-29-5.png" class="img-fluid" width="768"></p>
</div>
</div>
<p>Get basic stats as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>area <span class="op">=</span> ox.project_gdf(poznan_small).unary_union.area</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>stats <span class="op">=</span> ox.basic_stats(G_cycle, area<span class="op">=</span>area)</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>pd.Series(stats)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>n                                                                             568
m                                                                            1467
k_avg                                                                    5.165493
edge_length_total                                                      101250.782
edge_length_avg                                                         69.018938
streets_per_node_avg                                                     2.707746
streets_per_node_counts                 {0: 0, 1: 126, 2: 1, 3: 355, 4: 85, 5: 1}
streets_per_node_proportions    {0: 0.0, 1: 0.22183098591549297, 2: 0.00176056...
intersection_count                                                            442
street_length_total                                                     51276.381
street_segment_count                                                          749
street_length_avg                                                       68.459788
circuity_avg                                                             1.041883
self_loop_proportion                                                      0.00267
node_density_km                                                         178.71231
intersection_density_km                                                139.068382
edge_density_km                                                      31856.973767
street_density_km                                                    16133.310698
dtype: object</code></pre>
</div>
</div>
<p>We can convert the object into a ‘GeoDataFrame’ as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>cycle_gdf <span class="op">=</span> ox.graph_to_gdfs(G_cycle, edges<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>cycle_gdf[<span class="dv">1</span>].plot()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="osm_files/figure-html/unnamed-chunk-31-7.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="osmium" class="level2">
<h2 class="anchored" data-anchor-id="osmium">osmium</h2>
<p>Download the <a href="https://github.com/Robinlovelace/opengeohub2023/releases/download/v2/bbbike_Poznan.osm.pbf"><code>bbbike_Poznan.osm.pbf</code></a> file, e.g.&nbsp;as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">[</span> <span class="ot">!</span> <span class="ot">-f</span> bbbike_Poznan.osm.pbf <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">wget</span> https://github.com/Robinlovelace/opengeohub2023/releases/download/v2/bbbike_Poznan.osm.pbf</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Extract only lines that are tagged as <code>highway=cycleway</code> as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="ex">osmium</span> tags-filter bbbike_Poznan.osm.pbf w/highway=cycleway <span class="at">-o</span> poznan_cycleways.osm.pbf <span class="at">--overwrite</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can check that the operation worked with R or Python, e.g.&nbsp;as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>poznan_cycleways <span class="ot">=</span> sf<span class="sc">::</span><span class="fu">read_sf</span>(<span class="st">"poznan_cycleways.osm.pbf"</span>, <span class="at">layer =</span> <span class="st">"lines"</span>)</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(poznan_cycleways<span class="sc">$</span>geometry)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="exercises-1" class="level2">
<h2 class="anchored" data-anchor-id="exercises-1">Exercises</h2>
<ol type="1">
<li>Use the <code>query</code> argument of <code>oe_get()</code> to download only cycleways from the <code>bbbike</code> extract of Poznan (note: you may need to use <code>force_vectortranslate = TRUE</code> to update the data in the .gpkg file).</li>
<li>Develop a more sophisticated query to get an active travel network for Poznan
<ul>
<li>Bonus: add highways that are not footways/cycleways etc to ‘fill the gaps’ in the network generated in the preview step.</li>
</ul></li>
<li>Bonus: generate a simple measure of walkability or cyclability, perhaps with reference to the academic literature on ‘LTS’, the results shown in <a href="https://github.com/acteng/cyclability/">acteng/cyclability</a>, or other source.
<ul>
<li>Bonus bonus: where would you prioritise new active travel infrastructure in Poznan based on these results?</li>
</ul></li>
</ol>
</section>
</section>
<section id="sec-ideas" class="level1">
<h1>Ideas for using OSM data</h1>
<p>Take a look at the <a href="https://github.com/a-b-street/osm2streets/">a-b-street/osm2streets repo</a> and web app. Download .geojson files representing 2D extrusion of the network and explore in R, Python or a tool of your choice.</p>
<p>Test out the A/B Street game.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>